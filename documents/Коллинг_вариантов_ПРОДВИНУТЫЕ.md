# 1. Введение и общая информация

## 1.1 Обзор

В этом ноутбуке представлен полный рабочий процесс выявления однонуклеотидных вариантов (SNV) и многонуклеотидных полиморфизмов (MNP) в митохондриальной ДНК из выровненных файлов BAM, 
с особым акцентом на устранение ложноположительных вариантов, возникающих из-за **последовательностей ядерной митохондриальной ДНК (NUMT)**.

## 1.2 Почему фильтрация NUMT имеет важное значение

**Что такое NUMT?**
- Последовательности ядерной митохондриальной ДНК (NUMT) — это фрагменты мтДНК, которые были вставлены в ядерный геном в ходе эволюции.
- NUMT могут варьироваться от нескольких десятков пар оснований до почти полных последовательностей мтДНК.
- Когда чтения NGS выравнивывются с митохондриальным эталонным геномом, некоторые чтения,
полученные из NUMT, также могут выравниваться, вводя **ложноположительные варианты**.
- Без надлежащей фильтрации загрязнение NUMT может привести к неверным оценкам гетероплазмии и ложным выводам о вариантах.

**Почему фильтрация должна основываться на качестве чтения и базах данных популяции?**
- **Фильтры качества чтения:** NUMT обычно накапливают больше мутаций, чем настоящая мтДНК, и прочтения, полученные из NUMT, часто имеют характерные паттерны 
выравнивания (например, более низкое качество сопоставления, смещение цепи, необычные размеры вставок).
- **Фильтры базы данных населения:** Сравнивая обнаруженные варианты с базами данных, такими как gnomAD 
(митохондриальные), MITOMAP и HmtDB, мы можем различить:
  - Распространенные, доброкачественные варианты (присутствующие у многих людей)
  - Известные варианты, связанные с заболеваниями
  - Редкие или вероятно искусственные варианты (возможно, от NUMT)

## 1.3 Ключевые понятия

- **Гетероплазмия:** процент прчтений мтДНК, несущих определенный вариант (0–100 %).
- **Частота аллелей варианта (VAF):** эквивалентна уровню гетероплазмии.
- **Глубина покрытия:** количество прочтений, перекрывающих позицию в геноме; более высокая глубина повышает достоверность определения вариантов.
- **Смещение цепи:** когда вариант преимущественно появляется в прямых или обратных прочтениях; может указывать на артефакты секвенирования или NUMT.
- **Качество картирования:** уверенность в том, что прочтение сопоставлено с правильным местоположением в геноме.

---

# 2. Настройка и загрузка библиотек

```{r setup, message=FALSE, warning=FALSE}
# Load essential libraries
library(VariantAnnotation)
library(GenomicAlignments)
library(Rsamtools)
library(data.table)
library(ggplot2)
library(dplyr)
library(jsonlite)

# Optional: for advanced filtering
# BiocManager::install('VariantTools')
```

**Почему именно эти библиотеки?**
- `VariantAnnotation`: чтение и обработка файлов VCF (формат вызова вариантов).
- `GenomicAlignments`: работа с выровненными прочтениями и файлами BAM.
- `Rsamtools`: интерфейс для работы с файлами SAM/BAM
- `data.table` и `dplyr`: эффективная обработка и фильтрация данных.
- `ggplot2`: построение графиков публикационного ачества.

---

# 3. Выявление вариантов из файлов BAM

## 3.1 Общие сведения о выявлении вариантов

Выявление вариантов позволяет определить позиции, в которых выровненные чтения отличаются от эталонного генома. Для мтДНК мы используем специальные программы выявления вариантов, 
предназначенные для работы со следующими параметрами:
- Высокая глубина прочтения (мтДНК обычно присутствует в сотнях или тысячах копий на клетку)
- Низкочастотными вариантами (гетероплазмией)
- Артефактами выравнивания

## 3.2 Выявление вариантов с помощью внешних инструментов

*Для этой практической задачи мы рекомендуем использовать GATK Mutect2 или конвейер MitoHPC вне R, а затем импортировать результаты.*

### Вариант A: GATK Mutect2 (командная строка)

Ниже приведен пример команды оболочки. Выполните ее в терминале перед загрузкой результатов в R.

```bash
# Example GATK Mutect2 command for mtDNA variant calling
gatk Mutect2 \
  -R GRCh38.fa \
  -I aligned.bam \
  -O variants.vcf.gz \
  --mitochondria-mode
```

### Вариант B: Конвейер MitoHPC

MitoHPC — это специализированный конвейер для анализа мтДНК. Клонируйте и запустите из командной строки:

```bash
git clone https://github.com/ArkingLab/MitoHPC.git
cd MitoHPC
# Follow README for complete workflow
```

## 3.3 Импорт результатов VCF в R

```{r load-vcf, eval=FALSE}
# Load the VCF file generated by Mutect2 or MitoHPC
vcf_file <- "variants.vcf.gz"
vcf <- readVcf(vcf_file, "hg38")

# Extract key information
head(rowRanges(vcf))
head(geno(vcf))
```

---

# 4. Фильтрация по качеству на основе свойств прочтений

## 4.1 Обзор показателей качества

Для точной идентификации вариантов мтДНК фильтруйте варианты на основе:
- **Оценки QUAL:** уверенность в определении варианта по шкале Фреда (чем выше, тем лучше)
- **Глубина (DP):** общая глубина прочтений в положении варианта
- **Глубина аллеля (AD):** прчтения, поддерживающие каждый аллель (референсный и альтернативный)
- **Частота аллелей варианта (VAF):** соотношение альтернативных и общих прочтений
- **Качество сопоставления (MQ):** качество выравнивания прочтений
- **Смещение цепи (SB):** дисбаланс между прямыми и обратными прочтениями

## 4.2 Рекомендуемые пороговые значения качества для мтДНК

```{r quality-thresholds}
# Typical quality thresholds for mtDNA SNP/MNP calling
quality_thresholds <- data.frame(
  metric = c("QUAL score", "Depth (DP)", "VAF (heteroplasmy %)", 
             "Mapping Quality (MQ)", "Min reads per allele", "Max Strand Bias %"),
  min_threshold = c(30, 100, 0.5, 20, 5, 10),
  rationale = c(
    "Moderate confidence in variant call",
    "Adequate coverage for reliable variant detection",
    "Low frequency heteroplasmic variants (0.5% = detectable at 100x depth)",
    "Reliable alignment",
    "Minimum read support for each allele",
    "Forward/reverse balance to exclude strand bias artifacts"
  )
)

knitr::kable(quality_thresholds, caption = "Recommended Quality Thresholds for mtDNA Variants")
```

## 4.3 Реализация фильтрации качества

```{r quality-filter, eval=FALSE}
# Extract variant information from VCF
variant_df <- data.frame(
  position = start(rowRanges(vcf)),
  ref = as.character(ref(vcf)),
  alt = as.character(alt(vcf)),
  qual = qual(vcf),
  stringsAsFactors = FALSE
)

# Extract genotype and depth information
geno_data <- geno(vcf)
if (!is.null(geno_data$DP)) {
  variant_df$depth <- geno_data$DP[, 1]
}

if (!is.null(geno_data$AD)) {
  # AD is typically [ref_depth, alt_depth]
  ad_matrix <- geno_data$AD
  variant_df$ref_reads <- ad_matrix[[1]][, 1]
  variant_df$alt_reads <- ad_matrix[[1]][, 2]
  variant_df$vaf <- variant_df$alt_reads / (variant_df$ref_reads + variant_df$alt_reads)
}

# Apply quality filters
filtered_variants <- variant_df %>%
  filter(
    qual >= 30,                          # QUAL >= 30
    depth >= 100,                         # Depth >= 100x
    vaf >= 0.005,                         # VAF >= 0.5% (heteroplasmy)
    alt_reads >= 5                        # At least 5 reads supporting variant
  )

cat("Total variants before filtering:", nrow(variant_df), "\n")
cat("Variants after quality filtering:", nrow(filtered_variants), "\n")
cat("Filtered out:", nrow(variant_df) - nrow(filtered_variants), "variants\n")

# Visualize VAF distribution
ggplot(filtered_variants, aes(x = vaf * 100)) +
  geom_histogram(binwidth = 2, fill = "steelblue", color = "black") +
  labs(title = "Variant Allele Frequency (Heteroplasmy) Distribution",
       x = "Heteroplasmy (%)",
       y = "Number of Variants") +
  theme_minimal()
```

---

# 5. Фильтрация NUMT с использованием баз данных популяций

## 5.1 Доступные базы данных популяций мтДНК

### gnomAD Mitochondrial
- **URL:** https://gnomad.broadinstitute.org/
- **Содержит:** митохонднриальные варианты из ~17 000 образцов
- **Данные:** частота аллелей, уровни гетероплазмии, показатели качества

### MITOMAP
- **URL:** https://www.mitomap.org/
- **Содержит:** зарегистрированные мутации мтДНК, связи с заболеваниями, данные о популяции
- **Данные:** гомоплазматические и гетероплазматические варианты, информация о гаплогруппах

### HmtDB (База данных митохондриальных геновом человека)
- **URL:** https://www.hmtdb.unibo.it/
- **Содержит:** митохондриальные геномы, варианты, специфичные для популяции
- **Данные:** вариации последовательности, классификация гаплогрупп

## 5.2 Получение и подготовка данных

### Вариант A: Загрузк gnomAD mtDNA VCF

```{r gnomad-download, eval=FALSE}
# Download gnomAD v3.1 mtDNA variants (approximately 15 MB)
# From https://gnomad.broadinstitute.org/ → "Downloads" → "Mitochondrial DNA"
# File: gnomad.v3.1.sites.chrM.vcf.bgz

gnomad_vcf_file <- "gnomad.v3.1.sites.chrM.vcf.bgz"
gnomad_vcf <- readVcf(gnomad_vcf_file, "hg38")

# Extract gnomAD population allele frequencies
gnomad_variants <- data.frame(
  position = start(rowRanges(gnomad_vcf)),
  ref = as.character(ref(gnomad_vcf)),
  alt = as.character(alt(gnomad_vcf)),
  stringsAsFactors = FALSE
)

# Extract allele frequency info (if available in VCF INFO field)
info_data <- info(gnomad_vcf)
if (!is.null(info_data$AF)) {
  gnomad_variants$af_gnomad <- info_data$AF
} else if (!is.null(info_data$AF_hom)) {
  gnomad_variants$af_hom <- info_data$AF_hom
  gnomad_variants$af_het <- info_data$AF_het
}

head(gnomad_variants)
```

### Вариант B: Анализ данных MITOMAP

```{r mitomap-parse, eval=FALSE}
# MITOMAP provides a searchable database; download tables via their website
# Example: "Reported Polymorphisms" and "Diseases Associated with Mutations"

# For practical purposes, create a reference table manually or parse downloaded data
mitomap_ref <- data.frame(
  position = c(73, 150, 263, 310),  # Example positions
  ref = c("A", "C", "G", "T"),
  alt = c("G", "T", "A", "C"),
  category = c("common", "common", "disease-associated", "rare"),
  stringsAsFactors = FALSE
)

head(mitomap_ref)
```

## 5.3 Перекрестная ссылка обнаруженных вариантов на базы данных

```{r numt-filter-database, eval=FALSE}
# Create a unique variant identifier (position + ref + alt)
filtered_variants$variant_id <- paste0(
  filtered_variants$position, "_",
  filtered_variants$ref, "_",
  filtered_variants$alt
)

gnomad_variants$variant_id <- paste0(
  gnomad_variants$position, "_",
  gnomad_variants$ref, "_",
  gnomad_variants$alt
)

# Match against gnomAD
filtered_variants <- filtered_variants %>%
  left_join(
    gnomad_variants %>% select(variant_id, af_gnomad),
    by = "variant_id"
  )

# Flag variants not in gnomAD (potentially NUMT-derived or private variants)
filtered_variants$in_gnomad <- !is.na(filtered_variants$af_gnomad)

# Additional filtering:
# Keep only variants that are:
# 1. Present in gnomAD (common mtDNA variants), OR
# 2. Not in gnomAD but with high confidence (depth > 200, VAF > 1%, no strand bias)

high_confidence_variants <- filtered_variants %>%
  filter(
    in_gnomad | (depth > 200 & vaf > 0.01)
  )

cat("Variants after database filtering:", nrow(high_confidence_variants), "\n")
cat("Removed as likely NUMTs:", nrow(filtered_variants) - nrow(high_confidence_variants), "\n")

# Visualize gnomAD allele frequency vs detected variants
ggplot(high_confidence_variants, aes(x = af_gnomad, y = vaf * 100, color = in_gnomad)) +
  geom_point(alpha = 0.6, size = 3) +
  scale_x_log10() +
  labs(title = "Detected VAF vs gnomAD Allele Frequency",
       x = "gnomAD AF (log scale)",
       y = "Detected VAF (%)",
       color = "In gnomAD") +
  theme_minimal()
```

---

# 6. Расширенное обнаружение NUMT: анализ на уровне чтения

## 6.1 Харакеристики NUMT

NUMT часто демонстрируют:
- **Повышенную вариативность качества сопоставления** (смесь идеальных и плохих выравниваний)
- **Смещение цепи** (преимущественно на одной цепи)
- **Необычное распределение размеров вставок** (короче или длиннее, чем ожидалось
- **Высокая плотность мутаций** в локализованных областях
- **Филогенетически несовместимые варианты** (варианты, которые не соответствуют ожидаемой гаплогруппе образца)

## 6.2 Реализация фильтрации на уровне считывания

```{r read-level-numt-filter, eval=FALSE}
# Load BAM file for detailed read analysis
bam_file <- "aligned.bam"
param <- ScanBamParam(
  what = c("rname", "pos", "mapq", "qwidth", "seq", "qual"),
  tag = c("NM", "AS")  # NM = edit distance, AS = alignment score
)

reads <- scanBam(bam_file, param = param)[[1]]

# Convert to data frame
reads_df <- data.frame(
  position = reads$pos,
  mapq = reads$mapq,
  edit_distance = reads$tag$NM,
  alignment_score = reads$tag$AS,
  read_length = reads$qwidth,
  stringsAsFactors = FALSE
)

# Calculate edit distance ratio (higher = more mismatches, suspicious)
reads_df$edit_dist_ratio <- reads_df$edit_distance / reads_df$read_length

# Flag potential NUMT reads (high edit distance or low mapping quality)
reads_df$potential_numt <- reads_df$mapq < 20 | reads_df$edit_dist_ratio > 0.05

# Summarize by position
position_summary <- reads_df %>%
  group_by(position) %>%
  summarise(
    avg_mapq = mean(mapq),
    pct_high_edits = mean(edit_dist_ratio > 0.05) * 100,
    pct_potential_numt = mean(potential_numt) * 100,
    total_reads = n(),
    .groups = 'drop'
  )

# Positions with >20% NUMT-like reads are flagged
suspicious_positions <- position_summary %>%
  filter(pct_potential_numt > 20)

cat("Positions with elevated NUMT-like read fractions:\n")
print(head(suspicious_positions))

# Visualize mapping quality distribution
ggplot(reads_df, aes(x = mapq, fill = potential_numt)) +
  geom_histogram(binwidth = 2, alpha = 0.7) +
  labs(title = "Mapping Quality Distribution",
       x = "Mapping Quality (MAPQ)",
       y = "Number of Reads",
       fill = "Potential NUMT") +
  theme_minimal()
```

---

# 7. Фильтрация на основе гаплогрупп

## 7.1 Классификация гаплогрупп

Гаплогруппы мтДНК определяются набором диагностических вариантов. Классифицируя гаплогруппу образца, мы можем:
- Идентифицировать варианты, которые **ожидаются** в этой гаплогруппе (доброкачественные, определяющие гаплогруппу)
- Пометить варианты, которые **несовместимы** с гаплогруппой (потенциально из NUMT)
- Установить приоритет известных вариантов, связанных с заболеваниями

## 7.2 Назначение гапллгруппы (упрощенный подход)

```{r haplogroup-assign, eval=FALSE}
# Haplogroup-defining variants (simplified example)
# Full haplogroup trees available from: PhyloTree.org, MITOMAP

haplogroup_markers <- data.frame(
  haplogroup = c("H", "H", "J", "J", "T", "T", "U", "U"),
  position = c(7028, 16519, 185, 16069, 73, 153, 6392, 10398),
  variant = c("C", "G", "C", "C", "G", "C", "C", "A"),
  stringsAsFactors = FALSE
)

# Match detected variants against haplogroup markers
high_confidence_variants <- high_confidence_variants %>%
  left_join(
    haplogroup_markers,
    by = c("position" = "position", "alt" = "variant")
  )

# Count matching haplogroup markers
variant_summary <- high_confidence_variants %>%
  group_by(position, ref, alt) %>%
  summarise(
    haplogroup_matches = paste(unique(na.omit(haplogroup)), collapse = ", "),
    .groups = 'drop'
  )

cat("Sample haplogroup prediction:\n")
print(head(variant_summary))
```

---

# 8. Резюме и результаты

## 8.1 Финальная таблица отфильтрованных вариантов

```{r final-summary, eval=FALSE}
# Prepare final output table
final_variants <- high_confidence_variants %>%
  select(
    position, ref, alt, 
    depth, alt_reads, vaf,
    qual, in_gnomad, af_gnomad
  ) %>%
  arrange(position) %>%
  mutate(
    heteroplasmy_pct = round(vaf * 100, 2),
    af_gnomad = round(af_gnomad, 6),
    status = ifelse(in_gnomad, "known (gnomAD)", "novel/rare")
  ) %>%
  select(-vaf)

head(final_variants, 20)

# Save output
write.csv(final_variants, "mtdna_variants_filtered.csv", row.names = FALSE)
```

## 8.2 Визуализация результатов

```{r viz-results, eval=FALSE}
# Plot 1: Variant positions along mtDNA
ggplot(final_variants, aes(x = position, y = heteroplasmy_pct, color = status)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_rug(sides = "b", alpha = 0.5) +
  labs(title = "mtDNA Variant Map",
       x = "Position (bp)",
       y = "Heteroplasmy (%)",
       color = "Variant Status") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45))

# Plot 2: Coverage and variants
ggplot(final_variants, aes(x = depth, y = heteroplasmy_pct, color = status)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(title = "Sequencing Depth vs Heteroplasmy",
       x = "Coverage Depth (reads)",
       y = "Heteroplasmy (%)",
       color = "Variant Status") +
  theme_minimal()
```

---

# 9. Интерпретация и валидация

## 9.1 Отличие оригинальных вариантов мтДНК от NUMT

| Характеристика | Истинные варианты мтДНК | Варианты NUMT |
|---------|-------------------|---------------|
| Наличие в gnomAD/MITOMAP | Часто/да | Редко |
| Глубина покрытия | Высокая, равномерная | Переменная |
| Качество считывания (MAPQ) | Высокое (>25) | Низкое (<15) |
| Смещение цепи | Минимальное | Выраженное |
| Соответствует гаплогруппе | Соответствует ожидаемому | Несоответствует |
| Уровень гетероплазмии | 0,5%–100% | Часто <0,5% или спорадически |

## 9.2 Этапы валидации

1. **Перекрестная проверка с литературой:** поиск в MITOMAP и PUBMED зарегистрированных вариантов мтДНК в обнаруженных позициях.
2. **Исследование в IGV:** визуализируйте выровненные чтения в позициях вариантов, чтобы подтвердить их оригинальность.
3. **Биологическая правдоподобность:** рассмотрите, соответствуют ли обнаруженные варианты демографическим/клиническим характеристикам образца.
4. **Повторный анализ:** повторите анализ с использованием других программ определения вариантов или независимых образцов, чтобы подтвердить надежность обнаружения.

---

# 10. Заключение и следующие шаги

В этом ноутбуке представлена комплексная рабочая схкма для:
- Вызова вариантов SNP/MNP мтДНК из выровненных файлов BAM.
- Реализации многоуровневых фильтров качества.
- Использования баз данных популяций для удаления ложных срабатываний, полученных из NUMT.
- Проверки вариантов мтДНК с высокой степенью достоверности.

**Следующие шаги:**
- Функциональная аннотация вариантов (кодирующие vs. некодирующие, замены аминокислот)
- Количественная оценка гетероплазмии и ее динамика
- Присвоение гаплогрупп и филогенетический анализ
- сследования ассоциаций с фенотипами (при работе с большими когортами)

---

# Литература

- Barresi M. et al. (2025). «Биоинформационные инструменты для идентификации однонуклеотидных вариантов на основе NGS...» BioTech, PMC11843820.
- https://gnomad.broadinstitute.org/
- https://www.mitomap.org/
- https://www.hmtdb.unibo.it/
- The Mighty NUMT: Mitochondrial DNA Flexing Its Code in the Nuclear Genome. Biomolecules (2023), PMC10216076.

---

**Date:** `r Sys.Date()`
